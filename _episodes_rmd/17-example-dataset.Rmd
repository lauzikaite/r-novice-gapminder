---
title: "Mortality and survival in Game of Thrones"
subtitle: "Death is certain, the time is not"
teaching: 15
exercises: 40
questions:
- "How can I perform preliminary data quality visualisations?"
- "How can I undertake survival analysis?"
objectives:
- "Learn how to undertake preliminary data quality review and graphical visualitions."
- "Perform suvival analyses."
- "Estimate the probability of a character dying within the first hour after first being introduced on screen."
keypoints:
- "Load data into R."
- "Perform basic data visualisations using ggplot2 package."
- "Perform survival analyses using survival and survminer packages."
source: Rmd
---

```{r, include=FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("17-")
```

![](./../fig/GoT.png)


Let's start by downnloading Game of Thrones characters' mortality data, that was published [here](https://figshare.com/articles/Game_of_Thrones_mortality_and_survival_dataset/8259680?mc_cid=6ee60dc1ef&mc_eid=f10fe3b3f2). Please save the following two files using `File - Save As` dialog in your browser.

1. Original [characters data](https://raw.githubusercontent.com/lauzikaite/r-novice-gapminder/gh-pages/_episodes_rmd/data/character_data_S01-S08.csv)
2. Additional [data encoding](https://raw.githubusercontent.com/lauzikaite/r-novice-gapminder/gh-pages/_episodes_rmd/data/encoding.csv) table

> ## Challenge 1
>
> Save all three files your `data/` directory and change the working directory to it.
> Now read the `data/character_data_S01-S08.csv` and `data/encoding.csv` files into R.
>
> > ## Solution to Challenge 1
> >
> > ```{r, eval=FALSE}
> > setwd('path/to/data')
> > got_dat <- read.csv(file = "character_data_S01-S08.csv", header = TRUE, stringsAsFactors = FALSE)
> > meta <- read.csv(file = "encoding.csv", header = TRUE, stringsAsFactors = FALSE)
> > ```
> {: .solution}
{: .challenge}

```{r, eval=TRUE, echo=FALSE}
got_dat <- read.csv(file = "./data/character_data_S01-S08.csv", header = TRUE, stringsAsFactors = FALSE)
meta <- read.csv(file = "./data/encoding.csv", header = TRUE, stringsAsFactors = FALSE)
```

Once data is loaded into R, let's evualuate its quality.

> ## Challenge 2
>
> Does the table with GoT characters's mortality data look correct? Are there any missing entries? 
>
> > ## Solution to Challenge 2
> >
> > ```{r}
> > ## make a summary for each column 
> > summary(got_dat)
> > ```
> >
> > The last five columns have no entries at all and should be removed to not interfer with statistical analyses.
> > ```{r}
> > ## remove columns that only contain NAs as entries
> > got <- got_dat[ , which(!apply(got_dat, 2, function(x) all(is.na(x))))]
> > ```
> {: .solution}
{: .challenge}

## Graphical data exploration

To make graphical data visulisations, we will be using `ggplot`  library.

```{r, warning=FALSE,message=FALSE}
library(ggplot2)
```

First, we will make plots to check the distribution of different variables:

**Categorical**:

* sex
* religion
* occupation
* social_status
* allegiance
* ...

Type of **occupation** was categorised as “silk collar” (e.g. clergy, merchants, politicians, and rulers) or “boiled leather collar” (e.g. warriors, farmers, and other occupations relying heavily on manual work). 
Type of **social status** was categorised as “highborn” (lords, ladies, or legitimate offspring) or “lowborn” (all other characters).

Because some characters switched **allegiance** during the show, both their last known allegiance and whether or not they switched allegiance during the show were recorded.

**Continuous**:

* exp_time_sec, survival time of character
* intro_time_sec, cumulative net running time when character first appeared
* dth_episode, number of the episode in which character died
* prominence
* ...

A proxy measure for how prominently a character featured in the show was provided in the data. This **prominence** score was calculated by taking the number of episodes that a character appeared in and dividing that by the number of total episodes that the character could have appeared in (i.e. the number of episodes occurring from the character first being introduced until the point of death or censoring). This ratio was then multiplied by the number of seasons that the character had featured in.

> ## Quick question
>
> What every other variable in the dataset is: categorical or continuous?
{: .callout}

### Distribution

To begin with, let's compare three categorical variables, e.g. *occupation* vs *sex* vs *social status*.

> ## Challenge 3
>
> Make a histogram plot to show the distribution of three categorical variables of your choice, e.g. *occupation* vs *sex* vs *social status*. How can you ensure that all three variables are represented ina single figure? Tip - think about the aesthetics mapping in `ggplot()`.
>
> > ## Solution to Challenge 3
> >
> > ```{r}
> > ## make a summary for each column 
> > summary(got_dat)
> > ```
> >
> > The last five columns have no entries at all and should be removed to not interfer with statistical analyses.
> > ```{r, warning=FALSE, message=FALSE}
> > ggplot(got) +
> > geom_histogram(aes(x = factor(occupation), fill = factor(social_status)), stat = "count") +
> > facet_wrap(~sex) +
> > scale_x_discrete(name = "occupation") +
> > scale_fill_viridis_d(name = "social status")
```
> {: .solution}
{: .challenge}

This is not a very informative graph, because all categorical variables are encoded as numerical categories. Details of what number corresponds to what value are available in the `data_dictionary.pdf` file that you can download from the original data source [link](https://figshare.com/articles/Game_of_Thrones_mortality_and_survival_dataset/8259680?mc_cid=6ee60dc1ef&mc_eid=f10fe3b3f2). For simplicity's sake, we have saved them into the `data/encoding.csv` file, that you have loaded as `meta` object during Challenge 1.

> ## Challenge 4
>
> How can you find the values for each of the encoded categorical variable?
> Note - you can solve this using either basic R functions, or `dplyr` package. 
>
> > ## Solution to Challenge 4
> >
> > ```{r}
> > ## What are the categorial variables?
> > cols_cat <- unique(meta$variable)
> > ## iterate over the categorial variables
> > got_cat <- lapply(cols_cat, function(col) {
> >   ## extract the numerical categories for the variable
> >   got_col <- got[ , col]
> >   ## find the corresponding entries in the metadata encoding table 
> >   meta_col <- meta[meta$variable == col, ]
> >   meta_col$value[match(got_col, meta_col$code)]
> >   })
> > got_cat <- setNames(
> >   ## cbind the list of extracted values
> >   as.data.frame(do.call(cbind, got_cat)),
> >   nm = c(cols_cat))
> > ```
> >
> > Now that you have a data.frame with values for the categorical variables, re-run the distribution plot.
> > Make sure that x-axis is readible. Tip - rotate the labels.
> >
> > ```{r, warning=FALSE, message=FALSE}
> > ggplot(got_cat) +
> >   geom_histogram(aes(x = factor(occupation), fill = factor(social_status)), stat = "count") +
> >   facet_wrap(~sex) +
> >   scale_x_discrete(name = "occupation") +
> >   scale_fill_viridis_d(name = "social status") +
> >   theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
> {: .solution}
{: .challenge}


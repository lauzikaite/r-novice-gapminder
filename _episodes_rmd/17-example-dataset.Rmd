---
title: "Mortality and survival in Game of Thrones"
subtitle: "Death is certain, the time is not"
teaching: 15
exercises: 40
questions:
- "How can I perform basic graphical data visualisations?"
- "How can I perform survival analysis?"
objectives:
- "Explore GoT mortality dataset."
- "Visualise GoT datasetgraphically."
- "Get to know the basics of suvival analyses."
keypoints:
- "Load data into R."
- "Perform basic data visualisations using `ggplot2` package."
- "Perform survival analyses using `survival` and `survminer` packages."
source: Rmd
---

```{r, include=FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("17-")
```

![](./../fig/GoT.png)

Let's start by downloading Game of Thrones characters' mortality data, that was published [here](https://figshare.com/articles/Game_of_Thrones_mortality_and_survival_dataset/8259680?mc_cid=6ee60dc1ef&mc_eid=f10fe3b3f2). Please save the following two files using `File - Save As` dialog in your browser.

1. Original [characters data](https://raw.githubusercontent.com/lauzikaite/r-novice-gapminder/gh-pages/_episodes_rmd/data/character_data_S01-S08.csv)
2. Additional [data encoding](https://raw.githubusercontent.com/lauzikaite/r-novice-gapminder/gh-pages/_episodes_rmd/data/encoding.csv) table

> ## Challenge 1
>
> Save all three files your `data/` directory and change the working directory to it.
> Now read the `data/character_data_S01-S08.csv` and `data/encoding.csv` files into R.
>
> > ## Solution to Challenge 1
> >
> > ```{r, eval=FALSE}
> > setwd('path/to/data')
> > got_dat <- read.csv(file = "character_data_S01-S08.csv", header = TRUE, stringsAsFactors = FALSE)
> > meta <- read.csv(file = "encoding.csv", header = TRUE, stringsAsFactors = FALSE)
> > ```
> {: .solution}
{: .challenge}

```{r, eval=TRUE, echo=FALSE}
got_dat <- read.csv(file = "./data/character_data_S01-S08.csv", header = TRUE, stringsAsFactors = FALSE)
meta <- read.csv(file = "./data/encoding.csv", header = TRUE, stringsAsFactors = FALSE)
```

Once data is loaded into R, let's evaluate its quality.

> ## Challenge 2
>
> Does the table with GoT characters's mortality data look correct? Are there any missing entries? 
>
> > ## Solution to Challenge 2
> >
> > ```{r}
> > ## make a summary for each column 
> > summary(got_dat)
> > ```
> >
> > The last five columns have no entries at all and should be removed to not interfer with statistical analyses.
> > ```{r}
> > ## remove columns that only contain NAs as entries
> > got <- got_dat[ , which(!apply(got_dat, 2, function(x) all(is.na(x))))]
> > ```
> {: .solution}
{: .challenge}

## Graphical data exploration

To make graphical data visualisations, we will be using `ggplot`  library.

```{r, warning=FALSE,message=FALSE}
library(ggplot2)
```

First, we will make plots to check the distribution of different variables:

**Categorical**:

* sex
* religion
* occupation
* social_status
* allegiance
* dth_flag
* ...

Type of **occupation** was categorised as “silk collar” (e.g. clergy, merchants, politicians, and rulers) or “boiled leather collar” (e.g. warriors, farmers, and other occupations relying heavily on manual work). 
Type of **social status** was categorised as “highborn” (lords, ladies, or legitimate offspring) or “lowborn” (all other characters).

Because some characters switched **allegiance** during the show, both their last known allegiance and whether or not they switched allegiance during the show were recorded.

Whether character died or not during the period provided in the dataset is flagged in column **dth_flag**.

**Continuous**:

* exp_time_sec, survival time of character
* intro_time_sec, cumulative net running time when character first appeared
* dth_episode, number of the episode in which character died
* prominence
* icd10_cause_text, cause of death
* ...

A proxy measure for how prominently a character featured in the show was provided in the data. This **prominence** score was calculated by taking the number of episodes that a character appeared in and dividing that by the number of total episodes that the character could have appeared in (i.e. the number of episodes occurring from the character first being introduced until the point of death or censoring). This ratio was then multiplied by the number of seasons that the character had featured in.

> ## Quick question
>
> What every other variable in the dataset is: categorical or continuous?
{: .callout}

### Distribution

To begin with, let's compare three categorical variables, e.g. *occupation* vs *sex* vs *social status*.

> ## Challenge 3
>
> Make a histogram plot to show the distribution of three categorical variables of your choice, e.g. *occupation* vs *sex* vs *social status*. How can you ensure that all three variables are represented ina single figure? Tip - think about the aesthetics mapping in `ggplot()`.
>
> > ## Solution to Challenge 3
> >
> > ```{r}
> > ## make a summary for each column 
> > summary(got_dat)
> > ```
> >
> > The last five columns have no entries at all and should be removed to not interfer with statistical analyses.
> > ```{r, warning=FALSE, message=FALSE}
> > ggplot(got) +
> > geom_histogram(aes(x = factor(occupation), fill = factor(social_status)), stat = "count") +
> > facet_wrap(~sex) +
> > scale_x_discrete(name = "occupation") +
> > scale_fill_viridis_d(name = "social status")
```
> {: .solution}
{: .challenge}

This is not a very informative graph, because all categorical variables are encoded as numerical categories. Details of what number corresponds to what value are available in the `data_dictionary.pdf` file that you can download from the original data source [link](https://figshare.com/articles/Game_of_Thrones_mortality_and_survival_dataset/8259680?mc_cid=6ee60dc1ef&mc_eid=f10fe3b3f2). For simplicity's sake, we have saved them into the `data/encoding.csv` file, that you have loaded as `meta` object during Challenge 1.

> ## Challenge 4
>
> How can you find the values for each of the encoded categorical variable?
> Note - you can solve this using either basic R functions, or `dplyr` package. 
>
> > ## Solution to Challenge 4
> >
> > ```{r}
> > ## What are the categorial variables?
> > cols_cat <- unique(meta$variable)
> > ## iterate over the categorial variables
> > got_cat <- lapply(cols_cat, function(col) {
> >   ## extract the numerical categories for the variable
> >   got_col <- got[ , col]
> >   ## find the corresponding entries in the metadata encoding table 
> >   meta_col <- meta[meta$variable == col, ]
> >   meta_col$value[match(got_col, meta_col$code)]
> >   })
> > got_cat <- setNames(
> >   ## cbind the list of extracted values
> >   as.data.frame(do.call(cbind, got_cat)),
> >   nm = c(cols_cat))
> > ```
> >
> > Now that you have a data.frame with values for the categorical variables, re-run the distribution plot.
> > Make sure that x-axis is readible. Tip - rotate the labels.
> >
> > ```{r, warning=FALSE, message=FALSE}
> > ggplot(got_cat) +
> >   geom_histogram(aes(x = factor(occupation), fill = factor(social_status)), stat = "count") +
> >   facet_wrap(~sex) +
> >   scale_x_discrete(name = "occupation") +
> >   scale_fill_viridis_d(name = "social status") +
> >   theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
> {: .solution}
{: .challenge}

## Brief overview

The cause of death is stored in column `icd10_cause_text` in the original dataset. Value `dth_flag == 1` indicates that character died during the period described in the dataset.

```{r}
head(got[got$dth_flag == 1, "icd10_cause_text"])
```

> ## Challenge 5
>
> Provide answers to the following questions:
>
> * What proportion of characters died by the end of the period included in the dataset?
> * What are the major causes of death?
>
> > ## Solution to Challenge 5
> > 
> > ```{r}
> > chars_died <- nrow(got[got$dth_flag == 1, ])
> > chars_total <- nrow(got)
> > ## proportion of characters that died
> > chars_died/ chars_total * 100
> > ```
> > To identify the most common cause of death, use function `table` which calculates frequencies of entries.
> > 
> > ```{r}
> > causes <- table(got[got$dth_flag == 1, "icd10_cause_text"])
> > causes <- as.data.frame(causes[order(causes, decreasing = TRUE)])
> > causes$prop <- causes$Freq/chars_died * 100
> > cat(paste(causes$Var1,  "-", causes$prop, "\n", sep = " "))
> > ```
> {: .solution}
{: .challenge}

# Survival analysis

We will use Kaplan-Meier (KM) survival analysis with Cox proportional hazard regression modelling to quantify survival times and probabilities and to identify independent predictors of mortality, respectively.

## Kaplan-Meier model

The survival probability is the probability that an individual survives from the time origin (here, first appearance on the screen) to a specified future time (here, end of the period described in the dataset). The KM method is a non-parametric method used to estimate the survival probability from observed survival times. The KM survival curve provides a summary of the data and can be used to estimate e.g. median survival time.

### Fit data to model

We will use `survival` package to perform model fitting and `survminer` package for survival curves plots. Install and load required packages.

```{r, eval=FALSE}
install.packages(c("survival", "survminer"))
library(survival)
library(survminer)
```

```{r, echo=FALSE}
library(survival)
library(survminer)
```

First, we will fit mortality data to the KM model. Column **exp_time_hrs** stores survival time of character in the show (hours), column **dth_flag** indicates whether character has died. 

```{r}
surv_object <- Surv(time = got$exp_time_hrs, event = got$dth_flag)
```

The function `survfit` will be used to compute KM survival estimate. Its main arguments include:

* formula, represented by a survival object created using the function `Surv`.
* dataset containing the variables.

Let's plot the survival **probability** vs **time** in the show. Also add a line for median survival time.

```{r, warning=FALSE, message=FALSE}
surv_fit <- survfit(surv_object ~ 1, data = got)
ggsurvplot(surv_fit, data = got, surv.median.line = "hv")
```

Use the `surv_fit` object to extract the probability of surviving at least 1 h in the show.

```{r}
surv_sum <- summary(surv_fit)
## probabilities of surviving less than 1 hour
probs_1 <- surv_sum$surv[which(surv_sum$time < 1)]
## probability of surviving at least 1 hour
probs_1[length(probs_1)]
```

### Stratified survival

Let's check whether survival probability differs between various groups of characters. We will stratify individuals by:

* sex
* social_status
* allegiance_switched
* prominence

To compare two or more survival curves, most commonly log-rank test is applied. Essentially, the log rank test compares the observed number of events (i.e. deaths) in each group to what would be expected if the null hypothesis were true (i.e., if the survival curves were identical).

The function `survdiff` can be used to compute log-rank test comparing two or more survival curves. The variable that stratifies indivoduals into groups have to be specified in the function's formula.


> ## Challenge 6
>
> Fit KM model for the three variables: **sex**, **social_status**, **allegiance_switched**. You will need to specify these in the formula inside the `survfit` function.
> To add obtained p-value for test to the plot, use `pval = TRUE` argument in `ggsurvplot` function.
> Don't forget to use the data.frame with string values for categorical variables so that the plots would have clear labels.
>
> > ## Solution to Challenge 6
> > 
> > ```{r}
> > ## stratify by sex
> > surv_fit <- survfit(surv_object ~ sex, data = got_cat)
> > ggsurvplot(surv_fit, data = got, pval = TRUE)
> > ```
> > 
> > ```{r}
> > ## stratify by social_status
> > surv_fit <- survfit(surv_object ~ social_status, data = got_cat)
> > ggsurvplot(surv_fit, data = got, pval = TRUE)
> > ```
> >
> > ```{r}
> > ## stratify by allegiance_switched
> > surv_fit <- survfit(surv_object ~ allegiance_switched, data = got_cat)
> > ggsurvplot(surv_fit, data = got, pval = TRUE)
> > ```
> {: .solution}
{: .challenge}

In order to model survival based on **prominence**, which is a continuous variable, we have to categorise characters into groups (i.e. discrete variable). 

> ## Challenge 7
>
> Divide characters into tertiles (i.e. high, medium, and low) based on their **prominence**. Tip - one of possible ways of doing this is with `dplyr` package.
> Make a KM survival curve plot for the prominence categories.
>
> > ## Solution to Challenge 7
> > 
> > ```{r}
> > library(dplyr)
> > prominence_cats <- c("Low", "Medium", "High")
> > ## bin data into tertiles (n = 3)
> > got_cat$prominence_tertile <- ntile(got$prominence, n = 3)
> > got_cat$prominence <- prominence_cats[got_cat$prominence_tertile]
> > ```
> > 
> > ```{r}
> > ## stratify by prominence tertile
> > surv_fit <- survfit(surv_object ~ prominence, data = got_cat)
> > ggsurvplot(surv_fit, data = got, pval = TRUE)
> > ```
> {: .solution}
{: .challenge}

## Cox model

Cox proportional hazards regression analysis, which works for both quantitative predictor variables and for categorical variables, extends survival analysis methods to assess the effect  on survival time by of multiple risk factors simultaneously. 

The function `coxph` can be used to compute the Cox proportional hazards regression model. Its main arguments include:

* formula, represented by a survival object created using the function `Surv`.
* dataset containing the variables.

Univariate Cox regression for a single variable **sex**.

```{r}
coxph(surv_object ~ sex, data = got_cat)
```

### Multivariate Cox model

To perform multivariate Cox regression, all variables of interest must be listed in the formula. The obtained p-values indicate whether the relationship between survival and the given risk factor was significant. Which variables are significant in this Cox model?

```{r}
cox_fit <- coxph(surv_object ~ sex + social_status + allegiance_switched + prominence, data = got_cat)
print(cox_fit)
```

Hazard ratios (HR) are derived from the multivariate Cox model. Briefly, an HR > 1 indicates an increased risk of death if a specific risk factor is met by the individual. An HR < 1 indicates a decreased risk. Plot the obtained HR using function `ggforest`.

```{r}
ggforest(cox_fit, data = got_cat)
```

> ## Challenge 8
>
> What kind of a character was more likely to die in Game of Thrones?
>
> > ## Solution to Challenge 8
> > 
> > Character that was more likely to die in Game of Thrones:
> >
> > * Male, rather than female (but not statistically significant)
> > * Lowborn, rather than highborn
> > * Those who did not switch allegiance (loalty wins?)
> > * Characters who only featured moderately prominently (protection by the importance of the role?)
> > 
> {: .solution}
{: .challenge}


